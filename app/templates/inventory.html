{% extends "base.html" %}

{# =============================================================== #}
{# set variables #}
{# =============================================================== #}

{% set field_pairs = (('S', 'available'),('ID', 'id'),('Model','model'),
('CPUs','cpu_count'),('Model','cpu_model'),('Memory','memory_capacity'),
('Drives','model'),('Capacity','capacity'),('Count','count'),('Update',None)) %}

{% block scripts %}

{% endblock %}

{# =============================================================== #}
{# set body data #}
{# =============================================================== #}

{% block content %}
    <h2>Inventory</h2>
    <div style="padding-bottom: 10px;">
        Machines available for testing:<br>
    </div>
    <div class="pane-frame" style="width:100%;">
        <table id="projectstatus" class="sortable pane bigtable stripped">
            <thead>
                <tr class="header">
                {# create header for inventory table #}
                {% for k, v in field_pairs %}
                    {% if  v == None %}
                        {% set class = " class=sorttable_nosort" %}
                    {% endif %}
                    <th{{ class }}>
                        {{ k }}
                    </th>
                {% endfor %}
                </tr>
            </thead>
            <tbody>
            {# loop over servers in inventory #}
            {%- for server in servers -%}
                {% if server.holder.id == user.id %}
                    {% set class = " class=heldserver" %}
                {% else %}
                    {% set class = '' %}
                {% endif %}
                <tr{{ class }}>
                    {# loop over field values for each server #}
                    {% for k, v in field_pairs %}
                        <td>
                        {# if field is None, insert "update" button #}
                        {% if v != None %}
                            {% if k in ('Drives', 'Capacity', 'Count') %}
                            {% for drive in server['drive_counts'] %}
                            {{ drive[v] }}<br>
                            {% endfor %}
                            {% elif v == 'available' %}
                                {% if server['available'] %}
                                    {% set color = 'blue' %}
                                    {% set link = '/inventory/checkout/{}'.format(server.id) %}
                                    {% set hover_title = 'Check out this server' %}
                                {% elif server['held_by'] == user.id %}
                                    {% set color = 'green' %}
                                    {% set link = '/inventory/release/{}'.format(server.id) %}
                                    {% set hover_title = 'Release this server' %}
                                {% else %}
                                    {% set color = 'red' %}
                                    {% set link = '/inventory/checkout/{}'.format(server.id) %}
                                    {% set hover_title = 'This server is being used by someone else.' %}
                                {% endif %}
                            <a href={{ link }} title="{{ hover_title }}">
                                <img src={{ url_for('static', filename='pictures/{}.png'.format(color)) }} style="width:16px;height:16px;">
                            </a>
                                <span style="display:none">{{ color }}</span>
                        {% elif server[v] is not undefined %}
                        {% if k == 'ID' %}
                            <a href="/inventory/{{ server['id'] }}">
                                {{ server[v] }}
                            </a>
                        {% else %}
                            {{ server[v] }}
                        {% endif %}
                        {% endif %}
                        {% else %}
                            <form>
                                <button formaction='/inventory/update/{{ server.interfaces.filter_by(name='DRAC').first().mac }}'>
                                    Update
                                </button>
                            </form>
                        {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {# add link to create inventory at bottom of inventory list #}
    <div style="padding-top: 10px;">
        <a href="/inventory/add">Add inventory</a>
    </div>
{% endblock %}
